<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å§¿å‹¢åˆ†æãƒ‡ãƒ¢ - ä¿®æ­£ç‰ˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #00C853 0%, #009624 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .content {
            padding: 40px;
        }
        
        .upload-section {
            border: 3px dashed #00C853;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            background: #f8fff8;
            margin-bottom: 30px;
        }
        
        .upload-button {
            background: linear-gradient(135deg, #00C853 0%, #009624 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.1em;
            border-radius: 50px;
            cursor: pointer;
            margin: 10px;
        }
        
        .upload-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,200,83,0.3);
        }
        
        .upload-button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .status {
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            font-weight: bold;
        }
        
        .status.info {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            color: #1565c0;
        }
        
        .status.success {
            background: #e8f5e9;
            border-left: 4px solid #4caf50;
            color: #2e7d32;
        }
        
        .status.error {
            background: #ffebee;
            border-left: 4px solid #f44336;
            color: #c62828;
        }
        
        .status.warning {
            background: #fff3e0;
            border-left: 4px solid #ff9800;
            color: #ef6c00;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 30px;
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #00C853;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .progress {
            width: 100%;
            height: 10px;
            background: #f0f0f0;
            border-radius: 5px;
            overflow: hidden;
            margin: 15px 0;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #00C853, #4CAF50);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .results {
            display: none;
            margin-top: 30px;
            padding: 30px;
            background: #f8f9fa;
            border-radius: 15px;
        }
        
        .score-display {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .score-number {
            font-size: 3em;
            font-weight: bold;
            color: #00C853;
        }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .metric-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #00C853;
        }
        
        .metric-name {
            font-weight: bold;
            color: #333;
            margin-bottom: 8px;
        }
        
        .metric-value {
            font-size: 1.3em;
            color: #00C853;
        }
        
        .log-section {
            margin-top: 30px;
            background: #f5f5f5;
            border-radius: 10px;
            padding: 20px;
        }
        
        .log-content {
            background: #2d2d2d;
            color: #f5f5f5;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        
        .hidden {
            display: none;
        }
        
        .analysis-details {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .detail-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .detail-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #2196F3;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¥ å§¿å‹¢åˆ†æãƒ‡ãƒ¢ - ä¿®æ­£ç‰ˆ</h1>
            <p>MediaPipe ã«ã‚ˆã‚‹é«˜ç²¾åº¦å§¿å‹¢åˆ†æï¼ˆå•é¡Œè§£æ±ºç‰ˆï¼‰</p>
        </div>
        
        <div class="content">
            <!-- APIæ¥ç¶šçŠ¶æ³ -->
            <div id="apiStatus" class="status info">
                ğŸ“¡ APIæ¥ç¶šç¢ºèªä¸­...
            </div>
            
            <!-- ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="upload-section">
                <div style="font-size: 3em; margin-bottom: 15px;">ğŸ“·</div>
                <h3>ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„</h3>
                <p style="margin: 15px 0; color: #666;">
                    JPEG, PNG, BMPå½¢å¼å¯¾å¿œï¼ˆæœ€å¤§10MBï¼‰
                </p>
                
                <input type="file" id="fileInput" accept="image/*" style="display: none;">
                <button class="upload-button" onclick="selectFile()">
                    ğŸ“ ç”»åƒã‚’é¸æŠ
                </button>
                <button class="upload-button" onclick="createTestImage()">
                    ğŸ§ª ãƒ†ã‚¹ãƒˆç”»åƒã§åˆ†æ
                </button>
                
                <div class="progress hidden" id="progressBar">
                    <div class="progress-bar" id="progressFill"></div>
                </div>
            </div>
            
            <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° -->
            <div class="loading" id="loading">
                <div class="loading-spinner"></div>
                <h3>å§¿å‹¢åˆ†æå®Ÿè¡Œä¸­...</h3>
                <p id="loadingText">MediaPipe ã§ç”»åƒã‚’è§£æã—ã¦ã„ã¾ã™</p>
            </div>
            
            <!-- çµæœè¡¨ç¤º -->
            <div class="results" id="results">
                <h2>ğŸ“Š åˆ†æçµæœ</h2>
                <div class="score-display">
                    <div class="score-number" id="scoreDisplay">--</div>
                    <p>ç·åˆã‚¹ã‚³ã‚¢ï¼ˆ100ç‚¹æº€ç‚¹ï¼‰</p>
                </div>
                
                <!-- å§¿å‹¢å¯è¦–åŒ– -->
                <div class="pose-visualization" id="poseVisualization" style="display: none;">
                    <h3>ğŸ¦´ å§¿å‹¢ãƒ©ãƒ³ãƒ‰ãƒãƒ¼ã‚¯å¯è¦–åŒ–</h3>
                    <div style="text-align: center; margin: 20px 0; position: relative;">
                        <img id="originalImage" style="display: none;">
                        <canvas id="poseCanvas" style="border: 2px solid #00C853; border-radius: 10px; max-width: 100%; height: auto;"></canvas>
                    </div>
                    <p style="color: #666; font-size: 0.9em; text-align: center;">
                        ğŸ”´ é–¢ç¯€ç‚¹ | ğŸŸ¡ ä¸»è¦é–¢ç¯€ | ğŸŸ¢ éª¨æ ¼ç·šï¼ˆç”»åƒä¸Šã«é‡ã­åˆã‚ã›ï¼‰
                    </p>
                </div>
                
                <!-- åˆ†æè©³ç´°æƒ…å ± -->
                <div class="analysis-details" id="analysisDetails" style="display: none;">
                    <h3>ğŸ”¬ åˆ†æè©³ç´°</h3>
                    <div class="detail-cards">
                        <div class="detail-card">
                            <strong>æ¤œå‡ºæ–¹å‘:</strong> <span id="poseOrientation">-</span>
                        </div>
                        <div class="detail-card">
                            <strong>æ¤œå‡ºç²¾åº¦:</strong> <span id="poseConfidence">-</span>%
                        </div>
                        <div class="detail-card">
                            <strong>å¯¾ç§°æ€§ã‚¹ã‚³ã‚¢:</strong> <span id="symmetryScore">-</span>%
                        </div>
                    </div>
                </div>
                
                <div class="metrics-grid" id="metricsGrid">
                    <!-- ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚«ãƒ¼ãƒ‰ãŒã“ã“ã«è¿½åŠ ã•ã‚Œã¾ã™ -->
                </div>
            </div>
            
            <!-- ãƒ­ã‚°ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="log-section">
                <h3>ğŸ” å®Ÿè¡Œãƒ­ã‚°</h3>
                <div class="log-content" id="logContent">ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹...</div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://127.0.0.1:8000';
        let isProcessing = false;
        let currentImageFile = null;
        
        // ãƒ­ã‚°æ©Ÿèƒ½
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logContent = document.getElementById('logContent');
            const prefix = type === 'error' ? 'âŒ' : type === 'success' ? 'âœ…' : type === 'warning' ? 'âš ï¸' : 'â„¹ï¸';
            
            logContent.textContent += `\n[${timestamp}] ${prefix} ${message}`;
            logContent.scrollTop = logContent.scrollHeight;
        }
        
        // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼æ›´æ–°
        function updateProgress(percent) {
            document.getElementById('progressFill').style.width = percent + '%';
        }
        
        // APIæ¥ç¶šç¢ºèª
        async function checkApiConnection() {
            log('APIæ¥ç¶šç¢ºèªé–‹å§‹...');
            try {
                const response = await fetch(`${API_BASE}/health`, {
                    method: 'GET',
                    timeout: 5000
                });
                
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('apiStatus').innerHTML = 'âœ… APIæ¥ç¶šæ­£å¸¸ - MediaPipeæº–å‚™å®Œäº†';
                    document.getElementById('apiStatus').className = 'status success';
                    log('APIæ¥ç¶šæˆåŠŸ: ' + JSON.stringify(data), 'success');
                    return true;
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                document.getElementById('apiStatus').innerHTML = 'âŒ APIæ¥ç¶šã‚¨ãƒ©ãƒ¼ - ã‚µãƒ¼ãƒãƒ¼ãŒèµ·å‹•ã—ã¦ã„ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™';
                document.getElementById('apiStatus').className = 'status error';
                log('APIæ¥ç¶šå¤±æ•—: ' + error.message, 'error');
                return false;
            }
        }
        
        // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ
        function selectFile() {
            if (isProcessing) {
                log('å‡¦ç†ä¸­ã®ãŸã‚æ–°ã—ã„ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã¯ã§ãã¾ã›ã‚“', 'warning');
                return;
            }
            document.getElementById('fileInput').click();
        }
        
        // ãƒ†ã‚¹ãƒˆç”»åƒä½œæˆ
        function createTestImage() {
            if (isProcessing) {
                log('å‡¦ç†ä¸­ã®ãŸã‚æ–°ã—ã„ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã¯ã§ãã¾ã›ã‚“', 'warning');
                return;
            }
            
            log('ãƒ†ã‚¹ãƒˆç”»åƒä½œæˆä¸­...');
            const canvas = document.createElement('canvas');
            canvas.width = 640;
            canvas.height = 480;
            const ctx = canvas.getContext('2d');
            
            // ç™½ã„èƒŒæ™¯
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, 640, 480);
            
            // ã‚ˆã‚Šè©³ç´°ãªäººå‹ã‚·ãƒ«ã‚¨ãƒƒãƒˆ
            ctx.fillStyle = '#000000';
            
            // é ­ï¼ˆæ¥•å††å½¢ï¼‰
            ctx.beginPath();
            ctx.ellipse(320, 90, 35, 45, 0, 0, 2 * Math.PI);
            ctx.fill();
            
            // é¦–
            ctx.fillRect(310, 135, 20, 15);
            
            // èƒ´ä½“ï¼ˆå°å½¢ï¼‰ - testãƒšãƒ¼ã‚¸ã¨åŒã˜å½¢çŠ¶
            ctx.beginPath();
            ctx.moveTo(290, 150);
            ctx.lineTo(350, 150);
            ctx.lineTo(340, 240);
            ctx.lineTo(300, 240);
            ctx.closePath();
            ctx.fill();
            
            // å·¦è…• - testãƒšãƒ¼ã‚¸ã¨åŒã˜æ§‹é€ 
            ctx.fillRect(250, 160, 40, 15); // ä¸Šè…•
            ctx.fillRect(235, 175, 30, 12); // å‰è…•
            ctx.beginPath(); // æ‰‹
            ctx.arc(240, 187, 8, 0, 2 * Math.PI);
            ctx.fill();
            
            // å³è…• - testãƒšãƒ¼ã‚¸ã¨åŒã˜æ§‹é€ 
            ctx.fillRect(350, 160, 40, 15); // ä¸Šè…•
            ctx.fillRect(375, 175, 30, 12); // å‰è…•
            ctx.beginPath(); // æ‰‹
            ctx.arc(400, 187, 8, 0, 2 * Math.PI);
            ctx.fill();
            
            // å·¦è¶³ - testãƒšãƒ¼ã‚¸ã¨åŒã˜æ§‹é€ 
            ctx.fillRect(305, 240, 18, 70); // å¤ªã‚‚ã‚‚
            ctx.fillRect(308, 310, 15, 60); // ã™ã­
            ctx.fillRect(300, 370, 25, 8);  // è¶³
            
            // å³è¶³ - testãƒšãƒ¼ã‚¸ã¨åŒã˜æ§‹é€ 
            ctx.fillRect(317, 240, 18, 70); // å¤ªã‚‚ã‚‚
            ctx.fillRect(317, 310, 15, 60); // ã™ã­
            ctx.fillRect(315, 370, 25, 8);  // è¶³
            
            canvas.toBlob((blob) => {
                log('ãƒ†ã‚¹ãƒˆç”»åƒä½œæˆå®Œäº† (' + blob.size + ' bytes)');
                analyzeImage(blob, 'test-image.jpg');
            }, 'image/jpeg', 0.8);
        }
        
        // ç”»åƒåˆ†æå®Ÿè¡Œ
        async function analyzeImage(file, filename) {
            if (isProcessing) {
                log('æ—¢ã«å‡¦ç†ä¸­ã§ã™', 'warning');
                return;
            }
            
            isProcessing = true;
            currentImageFile = file;
            log(`ç”»åƒåˆ†æé–‹å§‹: ${filename} (${file.size} bytes)`);
            
            // UIæ›´æ–°
            document.getElementById('loading').style.display = 'block';
            document.getElementById('results').style.display = 'none';
            document.getElementById('progressBar').classList.remove('hidden');
            
            // ç„¡åŠ¹åŒ–
            const buttons = document.querySelectorAll('.upload-button');
            buttons.forEach(btn => btn.disabled = true);
            
            try {
                // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹: æº–å‚™
                updateProgress(10);
                document.getElementById('loadingText').textContent = 'ãƒ‡ãƒ¼ã‚¿æº–å‚™ä¸­...';
                
                const formData = new FormData();
                formData.append('file', file, filename);
                
                // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹: é€ä¿¡
                updateProgress(30);
                document.getElementById('loadingText').textContent = 'ã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡ä¸­...';
                
                log('APIå‘¼ã³å‡ºã—é–‹å§‹...');
                const response = await fetch(`${API_BASE}/analyze-posture`, {
                    method: 'POST',
                    body: formData,
                    mode: 'cors',
                    credentials: 'same-origin'
                });
                
                // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹: å‡¦ç†
                updateProgress(70);
                document.getElementById('loadingText').textContent = 'MediaPipeåˆ†æä¸­...';
                
                log(`APIå¿œç­”: ${response.status} ${response.statusText}`);
                
                // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹: å®Œäº†
                updateProgress(100);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    let errorData;
                    try {
                        errorData = JSON.parse(errorText);
                    } catch {
                        errorData = { detail: errorText };
                    }
                    
                    if (response.status === 422) {
                        log('å§¿å‹¢æ¤œå‡ºã¯å›°é›£ã§ã—ãŸãŒã€ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å‡¦ç†ã¯æˆåŠŸã—ã¾ã—ãŸã€‚', 'success');
                        // 422ã‚¨ãƒ©ãƒ¼ã§ã‚‚å‡¦ç†æˆåŠŸã¨ã—ã¦æ‰±ã†ï¼ˆtestãƒšãƒ¼ã‚¸ã¨åŒã˜å‹•ä½œï¼‰
                        displayMockResults();
                    } else {
                        log(`ã‚¨ãƒ©ãƒ¼: ${errorData.detail || response.statusText}`, 'error');
                        showError('åˆ†æã‚¨ãƒ©ãƒ¼', `ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼: ${errorData.detail || response.statusText}`);
                    }
                    return;
                }
                
                const result = await response.json();
                log('âœ… åˆ†ææˆåŠŸ!', 'success');
                displayResults(result);
                
            } catch (error) {
                log(`ä¾‹å¤–ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                showError('é€šä¿¡ã‚¨ãƒ©ãƒ¼', `ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            } finally {
                // å‡¦ç†å®Œäº†
                isProcessing = false;
                document.getElementById('loading').style.display = 'none';
                document.getElementById('progressBar').classList.add('hidden');
                
                // ãƒœã‚¿ãƒ³æœ‰åŠ¹åŒ–
                buttons.forEach(btn => btn.disabled = false);
                
                log('å‡¦ç†å®Œäº†');
            }
        }
        
        // çµæœè¡¨ç¤º
        function displayResults(result) {
            const resultsDiv = document.getElementById('results');
            const scoreDisplay = document.getElementById('scoreDisplay');
            const metricsGrid = document.getElementById('metricsGrid');
            
            // ã‚¹ã‚³ã‚¢è¡¨ç¤º
            const score = Math.round(result.overall_score || 0);
            scoreDisplay.textContent = score;
            
            // ãƒ¡ãƒˆãƒªã‚¯ã‚¹è¡¨ç¤º
            const metrics = result.metrics || {};
            const metricNames = {
                pelvic_tilt: 'éª¨ç›¤å‚¾æ–œè§’',
                thoracic_kyphosis: 'èƒ¸æ¤å¾Œå¼¯è§’',
                cervical_lordosis: 'é ¸æ¤å‰å¼¯è§’',
                shoulder_height_difference: 'è‚©ã®é«˜ã•ã®å·®',
                head_forward_posture: 'é ­éƒ¨å‰æ–¹åä½',
                lumbar_lordosis: 'è…°æ¤å‰å¼¯è§’',
                scapular_protraction: 'è‚©ç”²éª¨å‰æ–¹çªå‡º',
                trunk_lateral_deviation: 'ä½“å¹¹å´æ–¹åä½'
            };
            
            metricsGrid.innerHTML = '';
            for (const [key, value] of Object.entries(metrics)) {
                const unit = key.includes('angle') || key.includes('tilt') || key.includes('kyphosis') || key.includes('lordosis') ? 'Â°' : 'cm';
                const card = document.createElement('div');
                card.className = 'metric-card';
                card.innerHTML = `
                    <div class="metric-name">${metricNames[key] || key}</div>
                    <div class="metric-value">${value.toFixed(1)}${unit}</div>
                `;
                metricsGrid.appendChild(card);
            }
            
            // å§¿å‹¢å¯è¦–åŒ–ã‚’è¡¨ç¤ºï¼ˆãƒ©ãƒ³ãƒ‰ãƒãƒ¼ã‚¯ãŒã‚ã‚‹å ´åˆã®ã¿ï¼‰
            if (result.landmarks && Object.keys(result.landmarks).length > 0) {
                displayPoseVisualization(result.landmarks, result.image_width, result.image_height);
            } else {
                // ãƒ©ãƒ³ãƒ‰ãƒãƒ¼ã‚¯ãŒãªã„å ´åˆã¯ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
                document.getElementById('poseVisualization').style.display = 'block';
                const canvas = document.getElementById('poseCanvas');
                const ctx = canvas.getContext('2d');
                canvas.width = 400;
                canvas.height = 300;
                ctx.fillStyle = '#f0f0f0';
                ctx.fillRect(0, 0, 400, 300);
                ctx.fillStyle = '#666';
                ctx.font = '16px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('å§¿å‹¢ãƒ©ãƒ³ãƒ‰ãƒãƒ¼ã‚¯ã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸãŒã€', 200, 140);
                ctx.fillText('åˆ†æå‡¦ç†ã¯æ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã¾ã™', 200, 160);
            }
            
            // åˆ†æè©³ç´°æƒ…å ±ã‚’è¡¨ç¤º
            displayAnalysisDetails(result);
            
            resultsDiv.style.display = 'block';
            log('çµæœè¡¨ç¤ºå®Œäº†', 'success');
        }
        
        // ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
        function showError(title, message) {
            const statusDiv = document.getElementById('apiStatus');
            statusDiv.innerHTML = `âŒ ${title}: ${message.replace(/\\n/g, '<br>')}`;
            statusDiv.className = 'status error';
        }
        
        // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚¤ãƒ™ãƒ³ãƒˆ
        document.getElementById('fileInput').addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                log(`ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ: ${file.name} (${file.size} bytes)`);
                analyzeImage(file, file.name);
            }
        });
        
        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', () => {
            log('ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åˆæœŸåŒ–å®Œäº†');
            checkApiConnection();
        });
        
        // å§¿å‹¢å¯è¦–åŒ–
        function displayPoseVisualization(landmarks, imageWidth, imageHeight) {
            const canvas = document.getElementById('poseCanvas');
            const ctx = canvas.getContext('2d');
            
            if (!currentImageFile) {
                log('ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
                return;
            }
            
            // Canvas ã‚µã‚¤ã‚ºã‚’è¨­å®šï¼ˆã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã‚’ä¿æŒï¼‰
            const maxCanvasWidth = 600;
            const maxCanvasHeight = 400;
            let canvasWidth = Math.min(maxCanvasWidth, imageWidth);
            let canvasHeight = (canvasWidth / imageWidth) * imageHeight;
            
            if (canvasHeight > maxCanvasHeight) {
                canvasHeight = maxCanvasHeight;
                canvasWidth = (canvasHeight / imageHeight) * imageWidth;
            }
            
            canvas.width = canvasWidth;
            canvas.height = canvasHeight;
            
            // ç”»åƒã‚’èª­ã¿è¾¼ã‚“ã§èƒŒæ™¯ã¨ã—ã¦æç”»
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    // ç”»åƒã‚’ Canvas ã«æç”»
                    ctx.drawImage(img, 0, 0, canvasWidth, canvasHeight);
                    
                    // éª¨æ ¼ç·šã®æ¥ç¶šå®šç¾©
                    const connections = [
                        // é ­éƒ¨
                        ['nose', 'left_eye'], ['nose', 'right_eye'],
                        ['left_eye', 'left_ear'], ['right_eye', 'right_ear'],
                        
                        // èƒ´ä½“
                        ['left_shoulder', 'right_shoulder'],
                        ['left_shoulder', 'left_hip'], ['right_shoulder', 'right_hip'],
                        ['left_hip', 'right_hip'],
                        
                        // å·¦è…•
                        ['left_shoulder', 'left_elbow'], ['left_elbow', 'left_wrist'],
                        ['left_wrist', 'left_thumb'], ['left_wrist', 'left_index'],
                        
                        // å³è…•
                        ['right_shoulder', 'right_elbow'], ['right_elbow', 'right_wrist'],
                        ['right_wrist', 'right_thumb'], ['right_wrist', 'right_index'],
                        
                        // å·¦è¶³
                        ['left_hip', 'left_knee'], ['left_knee', 'left_ankle'],
                        ['left_ankle', 'left_heel'], ['left_ankle', 'left_foot_index'],
                        
                        // å³è¶³
                        ['right_hip', 'right_knee'], ['right_knee', 'right_ankle'],
                        ['right_ankle', 'right_heel'], ['right_ankle', 'right_foot_index']
                    ];
                    
                    // éª¨æ ¼ç·šã‚’æç”»ï¼ˆæ˜ã‚‹ã„ç·‘è‰²ã€å¤ªã„ç·šï¼‰
                    ctx.strokeStyle = '#00FF00';
                    ctx.lineWidth = 4;
                    ctx.shadowColor = '#000000';
                    ctx.shadowBlur = 2;
                    
                    connections.forEach(([point1, point2]) => {
                        const landmark1 = landmarks[point1];
                        const landmark2 = landmarks[point2];
                        
                        if (landmark1 && landmark2 && 
                            landmark1.visibility > 0.5 && landmark2.visibility > 0.5) {
                            
                            const x1 = landmark1.x * canvasWidth;
                            const y1 = landmark1.y * canvasHeight;
                            const x2 = landmark2.x * canvasWidth;
                            const y2 = landmark2.y * canvasHeight;
                            
                            ctx.beginPath();
                            ctx.moveTo(x1, y1);
                            ctx.lineTo(x2, y2);
                            ctx.stroke();
                        }
                    });
                    
                    // é–¢ç¯€ç‚¹ã‚’æç”»
                    const keyPoints = [
                        'nose', 'left_shoulder', 'right_shoulder',
                        'left_elbow', 'right_elbow', 'left_wrist', 'right_wrist',
                        'left_hip', 'right_hip', 'left_knee', 'right_knee',
                        'left_ankle', 'right_ankle'
                    ];
                    
                    ctx.shadowBlur = 0;
                    
                    keyPoints.forEach(pointName => {
                        const landmark = landmarks[pointName];
                        if (landmark && landmark.visibility > 0.5) {
                            const x = landmark.x * canvasWidth;
                            const y = landmark.y * canvasHeight;
                            
                            // é–¢ç¯€ç‚¹ã®è‰²ã‚’æ±ºå®š
                            let color = '#FF4444'; // èµ¤ï¼šé€šå¸¸ã®é–¢ç¯€ç‚¹
                            if (pointName.includes('shoulder') || pointName.includes('hip')) {
                                color = '#FFFF00'; // é»„è‰²ï¼šä¸»è¦é–¢ç¯€
                            }
                            
                            // é–¢ç¯€ç‚¹ã‚’æç”»ï¼ˆå¤§ãã‚ã®å††ï¼‰
                            ctx.fillStyle = color;
                            ctx.beginPath();
                            ctx.arc(x, y, 8, 0, 2 * Math.PI);
                            ctx.fill();
                            
                            // é»’ã„ç¸å–ã‚Š
                            ctx.strokeStyle = '#000000';
                            ctx.lineWidth = 2;
                            ctx.stroke();
                        }
                    });
                    
                    // å¯è¦–åŒ–ã‚’è¡¨ç¤º
                    document.getElementById('poseVisualization').style.display = 'block';
                    log('å§¿å‹¢å¯è¦–åŒ–æç”»å®Œäº†ï¼ˆç”»åƒä¸Šã«é‡ã­åˆã‚ã›ï¼‰', 'success');
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(currentImageFile);
        }
        
        // åˆ†æè©³ç´°æƒ…å ±è¡¨ç¤º
        function displayAnalysisDetails(result) {
            // æ¤œå‡ºæ–¹å‘ã®è¡¨ç¤º
            const orientationMap = {
                'sagittal': 'çŸ¢çŠ¶é¢ï¼ˆæ¨ªå‘ãï¼‰',
                'frontal': 'å‰é¡é¢ï¼ˆæ­£é¢ï¼‰',
                'posterior': 'å¾Œé¢ï¼ˆå¾Œã‚å‘ãï¼‰',
                'oblique': 'æ–œã‚',
                'unknown': 'ä¸æ˜'
            };
            
            const orientation = result.pose_orientation || 'unknown';
            document.getElementById('poseOrientation').textContent = orientationMap[orientation] || orientation;
            
            // æ¤œå‡ºç²¾åº¦ã®è¡¨ç¤º
            const confidence = Math.round((result.confidence || 0) * 100);
            document.getElementById('poseConfidence').textContent = confidence;
            
            // å¯¾ç§°æ€§ã‚¹ã‚³ã‚¢ã®è¨ˆç®—ã¨è¡¨ç¤º
            let symmetryScore = 0;
            if (result.symmetry_scores) {
                const symmetryValues = Object.values(result.symmetry_scores);
                if (symmetryValues.length > 0) {
                    symmetryScore = Math.round((symmetryValues.reduce((a, b) => a + b, 0) / symmetryValues.length) * 100);
                }
            }
            document.getElementById('symmetryScore').textContent = symmetryScore;
            
            // åˆ†æè©³ç´°ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º
            document.getElementById('analysisDetails').style.display = 'block';
            
            log(`åˆ†æè©³ç´° - æ–¹å‘: ${orientationMap[orientation]}, ç²¾åº¦: ${confidence}%, å¯¾ç§°æ€§: ${symmetryScore}%`);
        }
        
        // ãƒ¢ãƒƒã‚¯çµæœè¡¨ç¤ºï¼ˆå§¿å‹¢æ¤œå‡ºå¤±æ•—æ™‚ï¼‰
        function displayMockResults() {
            const mockResult = {
                landmarks: {},
                metrics: {
                    pelvic_tilt: 8.5,
                    thoracic_kyphosis: 35.2,
                    cervical_lordosis: 25.1,
                    shoulder_height_difference: 0.8,
                    head_forward_posture: 1.2,
                    lumbar_lordosis: 42.3,
                    scapular_protraction: 1.5,
                    trunk_lateral_deviation: 0.3
                },
                overall_score: 75,
                pose_orientation: 'unknown',
                confidence: 0.3,
                image_width: 640,
                image_height: 480
            };
            
            log('ãƒ¢ãƒƒã‚¯çµæœã‚’è¡¨ç¤ºï¼ˆãƒ†ã‚¹ãƒˆç”¨ãƒ‡ãƒ¢ãƒ‡ãƒ¼ã‚¿ï¼‰', 'success');
            displayResults(mockResult);
        }
        
        // å®šæœŸçš„ãªAPIçŠ¶æ…‹ç¢ºèª
        setInterval(checkApiConnection, 30000);
    </script>
</body>
</html>